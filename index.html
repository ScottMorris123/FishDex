<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FishDex</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-title" content="FishDex" />
<link rel="apple-touch-icon" href="icon-192.png" />

<style>
  :root{
    --bg:#0b0d10; --card:#13171c; --elev:#161b22; --text:#e7edf4; --muted:#9aa8b5;
    --accent:#2cd4a6; --border:#202732; --chip:#1b212b; --focus:#2cd4a633;
    --radius:16px;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;
  }
  a{ color:inherit; text-decoration:none }

  /* Top app bar */
  header{
    position: sticky; top:0; z-index:10;
    backdrop-filter: saturate(180%) blur(10px);
    background: color-mix(in srgb, var(--bg) 88%, transparent);
    border-bottom:1px solid var(--border);
    padding: 14px 18px; display:flex; align-items:center; gap:12px;
  }
  .brand{ font-weight:700; letter-spacing:.2px }
  .crumbs{ color:var(--muted); font-size:12px }
  .spacer{ flex:1 }
  .btn{
    padding:10px 12px; border:1px solid var(--border); background:var(--chip);
    border-radius:12px; color:var(--text); cursor:pointer;
  }
  .btn.primary{ background:var(--accent); color:#0b0d10; border:none }
  .btn.ghost{ background:transparent }
  .btn:focus-visible{ outline:2px solid var(--focus); outline-offset:2px }

  /* Layout */
  .app{ max-width: 960px; margin: 0 auto; padding-bottom: 96px }
  .wrap{ padding:18px; display:grid; gap:14px }
  .grid{ display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)) }
  .card{
    background: linear-gradient(180deg, var(--card), var(--elev));
    border:1px solid var(--border);
    border-radius: var(--radius);
    padding:16px; transition: transform .15s ease, border-color .15s ease;
  }
  .card:hover{ transform: translateY(-2px); border-color:#2a3240 }
  .title{ font-weight:600; margin:0 0 6px }
  .muted{ color:var(--muted) }

  /* Pills & inputs */
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    background:var(--chip); border:1px solid var(--border);
    padding:6px 10px; border-radius:999px; font-size:12px; color:var(--text);
  }
  .input{
    width:100%; border-radius:12px; border:1px solid var(--border); background:var(--chip);
    padding:10px 12px; color:var(--text)
  }
  .filters{
    display:grid; gap:10px; grid-template-columns: repeat(4, minmax(140px,1fr));
    padding:12px 18px; border-bottom:1px solid var(--border);
    background: color-mix(in srgb, var(--bg) 92%, transparent);
  }

  /* Species list */
  .item{
    display:flex; align-items:center; gap:12px; padding:12px;
    border:1px solid var(--border); border-radius:14px; background:var(--card)
  }
  .item .sp{ flex:1 }
  .sub{ font-size:12px; color:var(--muted) }
  .check{ width:20px; height:20px }

  /* Footer stats */
  .footer{
    position: fixed; left:0; right:0; bottom:0; z-index:10;
    background: color-mix(in srgb, var(--bg) 90%, transparent);
    border-top:1px solid var(--border); padding:10px 16px;
    display:flex; gap:8px; align-items:center; justify-content:center; flex-wrap:wrap;
  }
  .fade{ animation: fade .15s ease }
  @keyframes fade { from {opacity:0; transform: translateY(4px)} to {opacity:1; transform:none} }
</style>
</head>
<body>
  <header>
    <div class="brand">FishDex</div>
    <div class="crumbs" id="crumbs"></div>
    <div class="spacer"></div>
    <button class="btn ghost" id="exportBtn" title="Export">Export</button>
    <button class="btn ghost" id="importBtn" title="Import">Import</button>
    <button class="btn ghost" id="resetBtn" title="Reset">Reset</button>
  </header>

  <!-- Filters (persist in URL query & propagate between views) -->
  <section class="filters">
    <select id="f-env" class="input">
      <option value="">All habitats</option>
      <option value="freshwater">Freshwater</option>
      <option value="saltwater">Saltwater</option>
    </select>
    <select id="f-continent" class="input">
      <option value="">All continents</option>
      <option value="NA">North America</option>
      <option value="SA">South America</option>
      <option value="EU">Europe</option>
      <option value="AF">Africa</option>
      <option value="AS">Asia</option>
      <option value="OC">Oceania</option>
    </select>
    <input id="f-country" class="input" placeholder="Country (ISO-2, e.g. US)" />
    <input id="f-state" class="input" placeholder="State/Prov (ISO-3166-2, e.g. US-FL)" />
  </section>

  <main class="app">
    <div id="view" class="wrap fade"></div>
  </main>

  <div class="footer">
    <span class="muted" id="counts">0 caught / 0 total</span>
  </div>

  <!-- Your taxonomy & images map go here -->
  <script src="data.js"></script>
  <script>
/* ================= Core App ================= */

const $ = s => document.querySelector(s);
const view = $('#view'), crumbsEl = $('#crumbs'), countsEl = $('#counts');

const KEY='fishdex.v4';
const save = s => localStorage.setItem(KEY, JSON.stringify(s));
const load = () => JSON.parse(localStorage.getItem(KEY) || 'null');

// state stores only user progress; taxonomy comes from DATA (data.js)
let STATE = load() || { species: [] };

/* ---------- URL filter helpers ---------- */
function parseQuery(qs){
  const p = new URLSearchParams(qs || '');
  return {
    env: p.get('env') || '',
    cont: p.get('cont') || '',
    country: (p.get('country')||'').toUpperCase(),
    state: (p.get('state')||'').toUpperCase(),
    q: p.get('q') || ''
  };
}
function buildQuery(obj){
  const p = new URLSearchParams();
  if (obj.env) p.set('env', obj.env);
  if (obj.cont) p.set('cont', obj.cont);
  if (obj.country) p.set('country', obj.country.toUpperCase());
  if (obj.state) p.set('state', obj.state.toUpperCase());
  if (obj.q) p.set('q', obj.q);
  const s = p.toString();
  return s ? `?${s}` : '';
}
function readFiltersFromURL(){
  const [_, query=''] = (location.hash.split('?'));
  const f = parseQuery(query);
  // reflect into inputs
  const envSel = $('#f-env');
  const contSel = $('#f-continent');
  const cInp = $('#f-country');
  const sInp = $('#f-state');
  if (envSel) envSel.value = f.env;
  if (contSel) contSel.value = f.cont;
  if (cInp) cInp.value = f.country;
  if (sInp) sInp.value = f.state;
  return f;
}
function getFiltersFromInputs(){
  return {
    env: $('#f-env')?.value || '',
    cont: $('#f-continent')?.value || '',
    country: $('#f-country')?.value.trim().toUpperCase() || '',
    state: $('#f-state')?.value.trim().toUpperCase() || ''
  };
}
['f-env','f-continent','f-country','f-state'].forEach(id=>{
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === id) {
      const f = getFiltersFromInputs();
      const [path] = (location.hash || '#/groups').split('?');
      location.hash = `${path}${buildQuery(f)}`;
    }
  });
});
['f-country','f-state'].forEach(id=>{
  document.getElementById(id)?.addEventListener('keyup', (e)=>{
    if (e.key === 'Enter') {
      const f = getFiltersFromInputs();
      const [path] = (location.hash || '#/groups').split('?');
      location.hash = `${path}${buildQuery(f)}`;
    }
  });
});

/* ---------- Data binding ---------- */
function ensureOwned(sp){
  if (!STATE.species) STATE.species = [];
  let o = STATE.species.find(x=>x.id===sp.id);
  if (!o){
    o = { id: sp.id, caught:false, weight:'', length:'' };
    STATE.species.push(o); save(STATE);
  }
  return o;
}
function bindOwned(sp){ return { ...ensureOwned(sp), meta: sp }; }

/* ---------- Matching & counts ---------- */
function speciesMatchesFilters(sp, f){
  if (f.env && !(sp.habitats||[]).includes(f.env)) return false;
  if (f.cont && !(sp.continents||[]).includes(f.cont)) return false;
  if (f.country && !(sp.countries||[]).map(x=>x.toUpperCase()).includes(f.country)) return false;
  if (f.state && !(sp.states||[]).map(x=>x.toUpperCase()).includes(f.state)) return false;
  return true;
}
function setCrumbs(parts){ crumbsEl.textContent = parts.join(' / '); }
function setCountsFromList(list){
  const total = list.length;
  const caught = list.filter(o=>o.caught).length;
  countsEl.textContent = `${caught} caught / ${total} total${location.hash.includes('?')?' (filtered)':''}`;
}

/* ---------- UI components ---------- */
function speciesRow(own){
  const sp = own.meta;
  const metrics = [own.weight && own.weight, own.length && own.length].filter(Boolean).join(', ');
  const meta = `${own.caught ? 'Caught' : 'Not caught'}${metrics ? ' • ' + metrics : ''}`;
  const img = sp.img ? `<img src="${sp.img}" alt="${sp.name}" style="width:52px;height:52px;object-fit:contain;border-radius:10px;border:1px solid var(--border);background:#0e1116;padding:6px" />` : '';
  const habitatPills = sp.habitats?.length
    ? sp.habitats.map(h=>`<span class="pill">${h}</span>`).join(' ')
    : '';
  return `
    <div class="item">
      <input class="check" type="checkbox" ${own.caught?'checked':''} data-id="${own.id}" />
      ${img}
      <div class="sp">
        <div class="title">${sp.name} ${habitatPills}</div>
        <div class="sub">${meta}</div>
      </div>
      <button class="btn" data-edit="${own.id}">Details</button>
    </div>
  `;
}
function hookSpeciesEvents(list){
  list.forEach(own=>{
    const cb = document.querySelector(`input.check[data-id="${own.id}"]`);
    const ed = document.querySelector(`button[data-edit="${own.id}"]`);
    cb?.addEventListener('change', ()=>{ own.caught = cb.checked; save(STATE); setCountsFromList(list); });
    ed?.addEventListener('click', ()=>{
      const w = prompt(`Weight for ${own.meta.name} (e.g., "4.2 lb")`, own.weight || '');
      if (w !== null) own.weight = w.trim();
      const l = prompt(`Length for ${own.meta.name} (e.g., "19 in")`, own.length || '');
      if (l !== null) own.length = l.trim();
      save(STATE);
      route(); // re-render to show updates
    });
  });
}

/* ---------- Views ---------- */
function renderGroups(){
  const f = readFiltersFromURL();
  setCrumbs(['Groups']);

  // Filter species first
  const matched = DATA.species.filter(sp => speciesMatchesFilters(sp, f));

  // Only show groups that have ≥1 matching species
  const countsByGroup = new Map(); // groupId -> {total, caught}
  const ownedById = new Map(STATE.species.map(o=>[o.id,o]));
  matched.forEach(sp=>{
    (sp.groups||[]).forEach(gid=>{
      const curr = countsByGroup.get(gid) || {total:0, caught:0};
      curr.total += 1;
      if (ownedById.get(sp.id)?.caught) curr.caught += 1;
      countsByGroup.set(gid, curr);
    });
  });

  view.innerHTML = `
    <div class="grid">
      ${DATA.groups
        .filter(g => countsByGroup.has(g.id))
        .map(g=>{
          const c = countsByGroup.get(g.id);
          return `
            <a class="card" href="#/group/${g.id}${buildQuery(f)}">
              <h3 class="title">${g.name}</h3>
              <div class="muted">${c.caught} / ${c.total} caught</div>
            </a>
          `;
        }).join('')}
    </div>
  `;

  // Overall (filtered) counts across all matched species
  const owned = matched.map(sp => bindOwned(sp));
  setCountsFromList(owned);
}

function renderGroup(groupId){
  const f = readFiltersFromURL();
  const group = DATA.groups.find(g=>g.id===groupId);
  if(!group) return renderGroups();

  setCrumbs(['Groups', group.name]);

  const list = DATA.species
    .filter(sp => (sp.groups||[]).includes(groupId))
    .filter(sp => speciesMatchesFilters(sp, f))
    .sort((a,b)=>a.name.localeCompare(b.name))
    .map(sp => bindOwned(sp));

  view.innerHTML = `
    <div class="wrap" style="padding-top:10px">
      <div style="display:flex;gap:10px;align-items:center;margin:0 18px 6px">
        <a class="btn ghost" href="#/groups${buildQuery(f)}">← Back</a>
        <span class="pill">${group.name}</span>
      </div>
      <div id="list" class="wrap">
        ${list.map(speciesRow).join('')}
      </div>
    </div>
  `;
  setCountsFromList(list);
  hookSpeciesEvents(list);
}

/* ---------- Router ---------- */
function route(){
  const hash = location.hash || '#/groups';
  const [path] = hash.split('?');
  const parts = path.slice(2).split('/');

  if (parts[0]==='' || parts[0]==='groups') return renderGroups();
  if (parts[0]==='group' && parts[1]) return renderGroup(parts[1]);
  return renderGroups();
}
window.addEventListener('hashchange', route);
window.addEventListener('load', ()=>{ route(); });

/* ---------- Export / Import / Reset ---------- */
$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(STATE,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'fishdex.json'; a.click(); URL.revokeObjectURL(url);
});
$('#importBtn').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async () => {
    const f = inp.files?.[0]; if(!f) return;
    try{
      const parsed = JSON.parse(await f.text());
      if(!parsed || !Array.isArray(parsed.species)) return alert('Invalid file');
      // keep only species ids that exist in current DATA
      const allowed = new Set(DATA.species.map(s=>s.id));
      parsed.species = parsed.species.filter(s => allowed.has(s.id));
      STATE = parsed; save(STATE); route();
    }catch{ alert('Could not read file'); }
  };
  inp.click();
});
$('#resetBtn').addEventListener('click', ()=>{
  if(confirm('Reset your progress?')){ STATE = { species: [] }; save(STATE); route(); }
});

/* ---------- Service worker ---------- */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
  </script>
</body>
</html>
