<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0f14" />
  <title>FishDex</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    :root{--bg:#0b0f14;--bg2:#0e1116;--text:#e6edf3;--muted:#a1abb5;--accent:#3aa675;--accent-2:#2f7e59;--card:#121821;--border:#1e2633;--pill:#1a222e;--btn:#16202c;--danger:#c64545}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;color:var(--text);background:linear-gradient(180deg,#0b0f14,#0a121a);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    a{color:inherit}
    header{position:sticky;top:0;z-index:5;background:rgba(10,16,23,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .bar{display:flex;align-items:center;gap:10px;padding:10px 16px}
    .title{font-weight:700;letter-spacing:.2px}.spacer{flex:1}
    .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.08)}.btn.ghost{background:transparent}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--pill);border:1px solid var(--border);color:var(--muted);font-size:12px;margin-left:6px}
    .muted{color:var(--muted)}.wrap{max-width:1100px;margin:0 auto}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;padding:10px 16px;border-top:1px solid var(--border);background:var(--bg2)}
    select,input[type="text"]{background:var(--card);color:var(--text);border:1px solid var(--border);padding:8px 10px;border-radius:10px;outline:none;min-width:150px}
    input[type="text"]{min-width:120px}main{padding:16px}
    #crumbs{color:var(--muted);padding:8px 16px}#counts{padding:0 16px 12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:6px 8px}
    .card{display:block;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;text-decoration:none}
    .card:hover{border-color:#2a3547;box-shadow:0 0 0 1px #2a3547}
    .card .title{font-size:16px;margin:0 0 6px}
    .item{display:flex;align-items:center;gap:10px;border:1px solid var(--border);border-radius:14px;padding:10px;margin:8px 16px;background:var(--card)}
    .item .check{scale:1.2}.item .sp{flex:1}
    .item .sp .title{font-size:15px;margin-bottom:4px}.item .sp .sub{color:var(--muted);font-size:12px}
    footer{padding:24px;color:var(--muted);text-align:center}.danger{color:var(--danger)}
    @media (max-width:720px){.bar{flex-wrap:wrap}.toolbar{gap:8px}}
  </style>
</head>
<body>
  <header>
    <div class="bar wrap">
      <div class="title">üêü FishDex</div>
      <span class="pill">Sharded mode</span>
      <div class="spacer"></div>
      <button id="exportBtn" class="btn">Export</button>
      <button id="importBtn" class="btn">Import</button>
      <button id="resetBtn" class="btn">Reset</button>
    </div>
    <div class="toolbar wrap">
      <label>Env
        <select id="f-env">
          <option value="">Any</option>
          <option value="freshwater">Freshwater</option>
          <option value="brackish">Brackish</option>
          <option value="salt">Salt</option>
        </select>
      </label>
      <label>Continent
        <select id="f-continent">
          <option value="">Any</option>
          <option value="AF">Africa</option><option value="AN">Antarctica</option>
          <option value="AS">Asia</option><option value="EU">Europe</option>
          <option value="NA">North America</option><option value="OC">Oceania</option>
          <option value="SA">South America</option>
        </select>
      </label>
      <input id="f-country" type="text" placeholder="Country code (e.g., US)" />
      <input id="f-state"   type="text" placeholder="State/region code" />
      <div class="spacer"></div>
      <div id="counts" class="muted">0 caught / 0 total</div>
    </div>
  </header>

  <div id="crumbs" class="wrap">Families</div>
  <main class="wrap">
    <div id="view">Loading‚Ä¶</div>
  </main>
  <footer class="wrap muted">Data loads from <code>fishdex_sharded/</code> (families ‚Üí genera ‚Üí species). Works offline after first visit.</footer>

  <script>
/* ================= FishDex (Sharded) ================= */
const $ = s => document.querySelector(s);
const view = $('#view'), crumbsEl = $('#crumbs'), countsEl = $('#counts');

const KEY='fishdex.v5';
const ROOT='fishdex_sharded/';

let STATE = load() || { species: [] };
const cache = new Map();

function save(s){ localStorage.setItem(KEY, JSON.stringify(s)); }
function load(){ try{ return JSON.parse(localStorage.getItem(KEY)||''); }catch{ return null } }

async function jget(path){
  const url = ROOT + path.replace(/^\//,'');
  if (cache.has(url)) return cache.get(url);
  const res = await fetch(url);
  if(!res.ok) throw new Error('Fetch failed: '+url);
  const data = await res.json();
  cache.set(url, data);
  return data;
}

/* ---------- URL filters ---------- */
function parseQuery(qs){
  const p = new URLSearchParams(qs || '');
  return {
    env: p.get('env') || '',
    cont: p.get('cont') || '',
    country: (p.get('country')||'').toUpperCase(),
    state: (p.get('state')||'').toUpperCase(),
    q: p.get('q') || '',
    path: p.get('path') || '' // <-- override fetch path for genus
  };
}
function buildQuery(obj){
  const p = new URLSearchParams();
  if (obj.env) p.set('env', obj.env);
  if (obj.cont) p.set('cont', obj.cont);
  if (obj.country) p.set('country', obj.country.toUpperCase());
  if (obj.state) p.set('state', obj.state.toUpperCase());
  if (obj.q) p.set('q', obj.q);
  if (obj.path) p.set('path', obj.path);
  const s = p.toString();
  return s ? `?${s}` : '';
}
function readFiltersFromURL(){
  const [_, query=''] = (location.hash.split('?'));
  const f = parseQuery(query);
  const envSel = $('#f-env'), contSel = $('#f-continent'),
        cInp = $('#f-country'), sInp = $('#f-state');
  if (envSel) envSel.value = f.env;
  if (contSel) contSel.value = f.cont;
  if (cInp) cInp.value = f.country;
  if (sInp) sInp.value = f.state;
  return f;
}
function getFiltersFromInputs(){
  return {
    env: $('#f-env')?.value || '',
    cont: $('#f-continent')?.value || '',
    country: $('#f-country')?.value.trim().toUpperCase() || '',
    state: $('#f-state')?.value.trim().toUpperCase() || ''
  };
}
['f-env','f-continent','f-country','f-state'].forEach(id=>{
  document.addEventListener('change', (e)=>{
    if (e.target && e.target.id === id) {
      const f = getFiltersFromInputs();
      const [path] = (location.hash || '#/families').split('?');
      location.hash = `${path}${buildQuery(f)}`;
    }
  });
});
['f-country','f-state'].forEach(id=>{
  document.getElementById(id)?.addEventListener('keyup', (e)=>{
    if (e.key === 'Enter') {
      const f = getFiltersFromInputs();
      const [path] = (location.hash || '#/families').split('?');
      location.hash = `${path}${buildQuery(f)}`;
    }
  });
});

/* ---------- owned state ---------- */
function ensureOwned(sp){
  if (!STATE.species) STATE.species = [];
  let o = STATE.species.find(x=>x.id===sp.id);
  if (!o){
    o = { id: sp.id, caught:false, weight:'', length:'' };
    STATE.species.push(o); save(STATE);
  }
  return o;
}
function bindOwned(sp){ return { ...ensureOwned(sp), meta: sp }; }

/* ---------- filtering + counts ---------- */
function speciesMatchesFilters(sp, f){
  const envs = (sp.Environments||[]).map(s=>s.toLowerCase());
  if (f.env && !envs.includes(f.env.toLowerCase())) return false;

  const conts = (sp.Continents||sp.continents||[]);
  const countries = (sp.Countries||sp.countries||[]).map(x=>x.toUpperCase());
  const states = (sp.States||sp.states||[]).map(x=>x.toUpperCase());
  if (f.cont && !conts.includes(f.cont)) return false;
  if (f.country && !countries.includes(f.country)) return false;
  if (f.state && !states.includes(f.state)) return false;

  if (f.q){
    const hay = [
      sp.ScientificName||'',
      sp.CommonName||'',
      (sp.Subspecies||[]).map(s=>s.ScientificName||'').join(' ')
    ].join(' ').toLowerCase();
    if (!hay.includes(f.q.toLowerCase())) return false;
  }
  return true;
}
function setCrumbs(parts){ crumbsEl.innerHTML = parts.join(' / '); }
function setCountsFromList(list){
  const total = list.length;
  const caught = list.filter(o=>o.caught).length;
  const filteredTag = location.hash.includes('?') ? ' (filtered)' : '';
  countsEl.textContent = `${caught} caught / ${total} total${filteredTag}`;
}

/* ---------- UI helpers ---------- */
function pill(txt){ return `<span class="pill">${txt}</span>`; }
function speciesRow(own){
  const sp = own.meta;
  const metrics = [own.weight && own.weight, own.length && own.length].filter(Boolean).join(', ');
  const meta = `${own.caught ? 'Caught' : 'Not caught'}${metrics ? ' ‚Ä¢ ' + metrics : ''}`;
  const envPills = (sp.Environments||[]).map(pill).join(' ');
  const img = sp.img ? `<img src="${sp.img}" alt="${sp.ScientificName||sp.CommonName||''}" style="width:52px;height:52px;object-fit:contain;border-radius:10px;border:1px solid var(--border);background:#0e1116;padding:6px" />` : '';
  const title = sp.CommonName ? `${sp.CommonName} ‚Äî <i>${sp.ScientificName}</i>` : `<i>${sp.ScientificName}</i>`;
  return `
    <div class="item">
      <input class="check" type="checkbox" ${own.caught?'checked':''} data-id="${own.id}" />
      ${img}
      <div class="sp">
        <div class="title">${title} ${envPills}</div>
        <div class="sub">${meta}</div>
      </div>
      <button class="btn" data-edit="${own.id}">Details</button>
    </div>
  `;
}
function hookSpeciesEvents(list){
  list.forEach(own=>{
    const cb = document.querySelector(`input.check[data-id="${own.id}"]`);
    const ed = document.querySelector(`button[data-edit="${own.id}"]`);
    cb?.addEventListener('change', ()=>{ own.caught = cb.checked; save(STATE); setCountsFromList(list); });
    ed?.addEventListener('click', ()=>{
      const w = prompt(`Weight for ${(own.meta.CommonName||own.meta.ScientificName)} (e.g., "4.2 lb")`, own.weight || '');
      if (w !== null) own.weight = (w||'').trim();
      const l = prompt(`Length for ${(own.meta.CommonName||own.meta.ScientificName)} (e.g., "19 in")`, own.length || '');
      if (l !== null) own.length = (l||'').trim();
      save(STATE);
      route();
    });
  });
}

/* ---------- views ---------- */
async function renderFamilies(){
  const f = readFiltersFromURL();
  setCrumbs(['Families']);

  let fams = [];
  try{
    fams = await jget('index/families.json'); // array with family_index_path
  }catch(e){
    view.innerHTML = `
      <div class="wrap">
        <p class="danger">Couldn't load <code>fishdex_sharded/index/families.json</code>.</p>
        <p class="muted">${e.message}</p>
      </div>`;
    countsEl.textContent = '0 caught / 0 total';
    return;
  }

  view.innerHTML = `
    <div class="grid">
      ${fams.map(F => {
        // Prefer path-derived slug to avoid casing issues
        const famSlugFromPath = (F.family_index_path||'').split('/')[1] || slug(F.Family);
        return `
          <a class="card" href="#/family/${famSlugFromPath}${buildQuery(f)}">
            <h3 class="title">${F.Family}${F.Common?` ‚Äî ${F.Common}`:''}</h3>
            <div class="muted">
              ${pill(`Order: ${F.Order}`)}
              ${pill(`${F.GeneraCount ?? '‚Äî'} genera`)}
              ${pill(`${F.SpeciesCount ?? '‚Äî'} species`)}
            </div>
          </a>
        `;
      }).join('')}
    </div>
  `;
  countsEl.textContent = '0 caught / 0 total';
}

async function renderFamily(famSlug){
  const f = readFiltersFromURL();
  let fam;
  try{
    fam = await jget(`families/${famSlug}/index.json`);
  }catch(e){
    view.innerHTML = `<p class="danger">Missing family file: <code>fishdex_sharded/families/${famSlug}/index.json</code></p>`;
    return;
  }
  setCrumbs(['Families', fam.Family]);

  view.innerHTML = `
    <div class="wrap" style="padding-top:10px">
      <div style="display:flex;gap:10px;align-items:center;margin:0 18px 6px">
        <a class="btn ghost" href="#/families${buildQuery(f)}">‚Üê Back</a>
        <span class="pill">${fam.Family}</span>
        ${fam.Common ? `<span class="pill">${fam.Common}</span>` : ''}
        ${fam.Order ? `<span class="pill">Order: ${fam.Order}</span>` : ''}
      </div>
      <div class="grid">
        ${(fam.Genera||[]).map(G => {
          // Prefer exact path if provided
          const path = G.genus_path || `genera/${slug(fam.Family)}/${slug(G.Genus)}.json`;
          const encoded = encodeURIComponent(path);
          return `
            <a class="card" href="#/genus/${slug(fam.Family)}/${slug(G.Genus)}${buildQuery({...f, path: encoded})}">
              <h3 class="title"><i>${G.Genus}</i></h3>
              <div class="muted">${G.SpeciesCount ?? '‚Äî'} species</div>
            </a>
          `;
        }).join('')}
      </div>
    </div>
  `;
  countsEl.textContent = '0 caught / 0 total';
}

async function renderGenus(famSlug, genusSlug){
  const f = readFiltersFromURL();

  // If a precise path is provided (from families/<family>/index.json), use it.
  const overridePath = f.path ? decodeURIComponent(f.path) : '';
  const relPath = overridePath || `genera/${famSlug}/${genusSlug}.json`;

  let species = [];
  try{
    species = await jget(relPath);
  }catch(e){
    view.innerHTML = `<p class="danger">Missing genus file: <code>fishdex_sharded/${relPath}</code></p>`;
    countsEl.textContent = '0 caught / 0 total';
    return;
  }

  const list = species
    .map(sp => ({
      id: sp.SpecCode ? `spec:${sp.SpecCode}` : `name:${(sp.ScientificName||'').toLowerCase()}`,
      ScientificName: sp.ScientificName,
      CommonName: sp.CommonName || '',
      Environments: sp.Environments || [],
      Countries: sp.Countries || sp.countries || [],
      States: sp.States || sp.states || [],
      Continents: sp.Continents || sp.continents || [],
      Subspecies: sp.Subspecies || [],
      img: sp.img || null
    }))
    .filter(sp => speciesMatchesFilters(sp, f))
    .sort((a,b)=> (a.ScientificName||'').localeCompare(b.ScientificName||''))
    .map(sp => bindOwned(sp));

  setCrumbs(['Families', unslug(famSlug), `<i>${unslug(genusSlug)}</i>`]);

  view.innerHTML = `
    <div class="wrap" style="padding-top:10px">
      <div style="display:flex;gap:10px;align-items:center;margin:0 18px 6px">
        <a class="btn ghost" href="#/family/${famSlug}${buildQuery({...f, path:''})}">‚Üê Back</a>
        <span class="pill"><i>${unslug(genusSlug)}</i></span>
      </div>
      <div id="list" class="wrap">
        ${list.map(speciesRow).join('')}
      </div>
    </div>
  `;
  setCountsFromList(list);
  hookSpeciesEvents(list);
}

/* ---------- router ---------- */
function slug(s){ return String(s).toLowerCase().replace(/\s+/g,'-').replace(/[^\w-]/g,''); }
function unslug(s){ return String(s).replace(/-/g,' '); }

function route(){
  const hash = location.hash || '#/families';
  const [path] = hash.split('?');
  const parts = path.slice(2).split('/');

  if (parts[0]==='' || parts[0]==='families') return renderFamilies();
  if (parts[0]==='family' && parts[1]) return renderFamily(parts[1]);
  if (parts[0]==='genus' && parts[1] && parts[2]) return renderGenus(parts[1], parts[2]);
  return renderFamilies();
}
window.addEventListener('hashchange', route);
window.addEventListener('load', ()=>{ route(); });

/* ---------- export/import/reset ---------- */
$('#exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(STATE,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href = url; a.download = 'fishdex.json'; a.click(); URL.revokeObjectURL(url);
});
$('#importBtn').addEventListener('click', ()=>{
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = async () => {
    const f = inp.files?.[0]; if(!f) return;
    try{
      const parsed = JSON.parse(await f.text());
      if(!parsed || !Array.isArray(parsed.species)) return alert('Invalid file');
      STATE = parsed; save(STATE); route();
    }catch{ alert('Could not read file'); }
  };
  inp.click();
});
$('#resetBtn').addEventListener('click', ()=>{
  if(confirm('Reset your progress?')){ STATE = { species: [] }; save(STATE); route(); }
});

/* ---------- service worker ---------- */
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js')); }
  </script>
</body>
</html>
